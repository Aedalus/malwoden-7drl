{"version":3,"sources":["terrain.ts","logs.ts","globals.ts","stage.ts","prefabs.ts","generation/helpers.ts","generation/stage-1.ts","generation/stage-2.ts","generation/stage-3.ts","generation/generation.ts","systems/levelSystem.ts","systems/RenderSystem.ts","systems/InputSystem.ts","systems/MovementSystem.ts","game.ts","damageFunction.ts","systems/AISystem.ts","systems/StairSystem.ts","systems/CacheSystem.ts","systems/CombatSystem.ts","systems/ViewSystem.ts","systems/ConsumableSystem.ts","App.tsx","reportWebVitals.js","index.tsx"],"names":["Terrain","LogLevel","TerrainCollision","none","tree","mountain","hedge","mushroomRed","mushroomPurple","mushroomDarkPurple","wall","TerrainGlyphs","Glyph","fromCharCode","CharCode","blackSquare","Color","Black","blackSpadeSuit","Green","blackUpPointingTriangle","Brown","greekSmallLetterPi","Red","blackClubSuit","MediumPurple","Purple","asterisk","White","FOWTerrainGlyphs","blendPercent","DimGray","DarkGray","Gray","TerrainBlocksVision","GameState","Direction","Log","maxLogs","entries","lastEntry","lastEntryCount","txt","this","addEntry","LOW","MID","HIGH","WARNING","logLevel","pop","push","length","shift","map_width","map_height","Stage","name","map","entities","startPos","entites","fow","fowVisited","Util","Table","width","height","e","filter","x","id","rng","Rand","AleaRNG","getScorpion","options","Math","random","toString","enemy","position","renderPriority","glyph","poundSign","AliceBlue","ai","collision","vision","stats","hp","maxHp","level","attack","armor","exp","getAnts","caret","getRabbit","rUpper","WhiteSmoke","getLadybug","lUpper","getShellGuardian","at","getPlayer","player","incomingDamage","Yellow","getStairs","downwardsArrow","Cyan","stairs","getBerry","amount","nextItem","color","LightBlue","bullet","consumable","getBook","equals","strokeTable","table","val","y","set","generateStage1","createPlayer","config","Generation","CellularAutomata","aliveValue","deadValue","randomize","doSimulationStep","connect","open","get","randomOpen","shuffle","rngPos","Prefab","i","enemies","nextBoolean","mUpper","Orange","berries","berry","books","book","generateStage2","DrunkardsWalk","topology","walkSteps","steps","Infinity","maxCoveredTiles","sUpper","scorpions","generateStage3","mysticShell","qUpper","IndianRed","shellPos","clearPos","pos","isInBounds","walls","doors","winCondition","w","d","selectStage","stage","Error","state","stageCount","posCache","Map","playerCache","undefined","help","currentGameState","GAME_START","restart","addEntryHigh","newLevel","getEXPForLevel","LevelSystem","find","bonus","round","logLevelColor","high","mid","low","warning","RenderSystem","mouse","Input","MouseHandler","terminal","mapTerminal","clear","playerViewshed","viewShed","area","GUI","box","title","origin","writeAt","drawBar","expNext","expLast","lvlExp","curExp","Gold","logColor","v","terrain","drawGlyph","drawCharCode","entitiesInSight","forEach","sortedEntities","sort","a","b","infoEntities","localeCompare","min","fore","mousePos","getPos","termPos","pixelToChar","worldPos","has","selectedEntities","text","textPos","leftwardsArrow","DarkSlateGray","rightwardsArrow","drawLabel","GAME_WIN","wX","wY","mX","mY","winAnim","faceRight","dX","qX","qY","renderWon","GAME_LOSS","renderLost","isX","isY","cX","cY","renderHelp","render","percent","filledWidth","floor","c","blend","PlayerInput","setInterval","InputSystem","currentPlayerInput","NONE","keyboard","KeyboardHandler","movement","KeyboardContext","onDown","KeyCode","DownArrow","DOWN","LeftArrow","LEFT","RightArrow","RIGHT","UpArrow","UP","Space","SPACE","Escape","ESC","H","HELP","setContext","wasInput","wantsToMove","directionVectors","MovementSystem","direction","stepPos","stepEntities","some","checkCombat","dirty","currentEntity","blockingEntities","otherFactionEntity","source","target","defence","totalDefence","calcDefence","power","totalAttack","calcAttack","damage","notifyDamage","dealDamage","AISystem","chaseAI","wanderAI","guardAI","getDirectionFromVectors","playerPos","route","Pathfinding","AStar","isBlockedCallback","compute","console","warn","start","next","dx","dy","dir","getRandDirection","StairSystem","s","addEntryMid","addEntity","CacheSystem","key","CombatSystem","futureCorpse","addEntryWarning","check","makeCorpse","creature","incDamage","applyDamage","addEntryLow","checkAlive","ViewSystem","fov","FOV","PreciseShadowcasting","cartesianRange","lightPasses","tiles","calculateArray","t","ConsumableSystem","entitesOnSpace","consumed","removeEntity","renderSystem","inputSystem","movementSystem","aiSystem","stairSystem","cacheSystem","viewSystem","combatSystem","levelSystem","consumableSystem","App","requestRef","React","useRef","NaN","useEffect","mount","document","getElementById","Terminal","RetroTerminal","imageURL","charWidth","charHeight","mountNode","port","loop","current","window","requestAnimationFrame","AWAITING_INPUT","PLAYER_TURN","ENEMY_TURN","Game","cancelAnimationFrame","style","display","justifyContent","paddingTop","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","StrictMode"],"mappings":"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","file":"static/js/main.752b4e6e.chunk.js","sourcesContent":["import { CharCode, Color, Glyph } from \"malwoden\";\r\n\r\n// Level\r\nexport enum Terrain {\r\n  none = 0,\r\n  tree = 1,\r\n  mountain = 2,\r\n  hedge = 4,\r\n\r\n  mushroomRed = 5,\r\n  mushroomPurple = 6,\r\n  mushroomDarkPurple = 7,\r\n\r\n  wall = 8,\r\n}\r\n\r\nexport const TerrainCollision: { [e in Terrain]: boolean } = {\r\n  [Terrain.none]: false,\r\n  [Terrain.tree]: true,\r\n  [Terrain.mountain]: true,\r\n  [Terrain.hedge]: true,\r\n\r\n  [Terrain.mushroomRed]: true,\r\n  [Terrain.mushroomPurple]: true,\r\n  [Terrain.mushroomDarkPurple]: true,\r\n\r\n  [Terrain.wall]: true,\r\n};\r\n\r\nexport const TerrainGlyphs: { [e in Terrain]: Glyph | undefined } = {\r\n  [Terrain.none]: Glyph.fromCharCode(\r\n    CharCode.blackSquare,\r\n    Color.Black,\r\n    Color.Black\r\n  ),\r\n  [Terrain.tree]: Glyph.fromCharCode(CharCode.blackSpadeSuit, Color.Green),\r\n  [Terrain.mountain]: Glyph.fromCharCode(\r\n    CharCode.blackUpPointingTriangle,\r\n    Color.Brown\r\n  ),\r\n  [Terrain.hedge]: Glyph.fromCharCode(CharCode.greekSmallLetterPi),\r\n\r\n  [Terrain.mushroomRed]: Glyph.fromCharCode(CharCode.blackSpadeSuit, Color.Red),\r\n  [Terrain.mushroomPurple]: Glyph.fromCharCode(\r\n    CharCode.blackClubSuit,\r\n    Color.MediumPurple\r\n  ),\r\n  [Terrain.mushroomDarkPurple]: Glyph.fromCharCode(\r\n    CharCode.blackSpadeSuit,\r\n    Color.Purple\r\n  ),\r\n  [Terrain.wall]: Glyph.fromCharCode(CharCode.asterisk, Color.White),\r\n};\r\n\r\nexport const FOWTerrainGlyphs: { [e in Terrain]: Glyph | undefined } = {\r\n  [Terrain.none]: Glyph.fromCharCode(\r\n    CharCode.blackSquare,\r\n    Color.Black.blendPercent(Color.DimGray, 50),\r\n    Color.Black.blendPercent(Color.DimGray, 50)\r\n  ),\r\n  [Terrain.tree]: Glyph.fromCharCode(\r\n    CharCode.blackSpadeSuit,\r\n    Color.Black.blendPercent(Color.DimGray, 20),\r\n    Color.Black.blendPercent(Color.DimGray, 50)\r\n  ),\r\n  [Terrain.mountain]: Glyph.fromCharCode(\r\n    CharCode.blackUpPointingTriangle,\r\n    Color.DarkGray\r\n  ),\r\n  [Terrain.hedge]: Glyph.fromCharCode(CharCode.greekSmallLetterPi),\r\n  [Terrain.mushroomRed]: Glyph.fromCharCode(\r\n    CharCode.blackSpadeSuit,\r\n    Color.Gray\r\n  ),\r\n  [Terrain.mushroomPurple]: Glyph.fromCharCode(\r\n    CharCode.blackClubSuit,\r\n    Color.DimGray\r\n  ),\r\n  [Terrain.mushroomDarkPurple]: Glyph.fromCharCode(\r\n    CharCode.blackSpadeSuit,\r\n    Color.DarkGray\r\n  ),\r\n  [Terrain.wall]: Glyph.fromCharCode(CharCode.asterisk, Color.Gray),\r\n};\r\n\r\n// Used by View System to calculate FOV\r\nexport const TerrainBlocksVision: { [e in Terrain]: boolean } = {\r\n  [Terrain.none]: false,\r\n  [Terrain.tree]: true,\r\n  [Terrain.mountain]: true,\r\n  [Terrain.hedge]: true,\r\n  [Terrain.mushroomRed]: true,\r\n  [Terrain.mushroomPurple]: true,\r\n  [Terrain.mushroomDarkPurple]: true,\r\n  [Terrain.wall]: true,\r\n};\r\n","export enum LogLevel {\r\n  LOW = \"low\",\r\n  MID = \"mid\",\r\n  HIGH = \"high\",\r\n  WARNING = \"warning\",\r\n}\r\n\r\nclass LogManifest {\r\n  maxLogs = 7;\r\n  entries: [LogLevel, string][] = [];\r\n  lastEntry: string = \"\";\r\n  lastEntryCount: number = 1;\r\n\r\n  addEntryLow(txt: string) {\r\n    this.addEntry(LogLevel.LOW, txt);\r\n  }\r\n\r\n  addEntryMid(txt: string) {\r\n    this.addEntry(LogLevel.MID, txt);\r\n  }\r\n\r\n  addEntryHigh(txt: string) {\r\n    this.addEntry(LogLevel.HIGH, txt);\r\n  }\r\n\r\n  addEntryWarning(txt: string) {\r\n    this.addEntry(LogLevel.WARNING, txt);\r\n  }\r\n\r\n  addEntry(logLevel: LogLevel, txt: string) {\r\n    if (txt === this.lastEntry) {\r\n      this.lastEntryCount++;\r\n      this.entries.pop();\r\n      this.entries.push([logLevel, `${txt} (x${this.lastEntryCount})`]);\r\n    } else {\r\n      this.entries.push([logLevel, txt]);\r\n      this.lastEntryCount = 1;\r\n    }\r\n\r\n    this.lastEntry = txt;\r\n    // Ensure we never go above max\r\n    while (this.entries.length > this.maxLogs) this.entries.shift();\r\n  }\r\n\r\n  length() {\r\n    return this.entries.length;\r\n  }\r\n}\r\n\r\nexport const Log = new LogManifest();\r\n","import { Entity } from \"./entities\";\r\nimport { Stage } from \"./stage\";\r\nimport { selectStage } from \"./generation/generation\";\r\nimport { Rand } from \"malwoden\";\r\nimport { Log } from \"./logs\";\r\n\r\nexport enum GameState {\r\n  GAME_START,\r\n  PLAYER_TURN,\r\n  ENEMY_TURN,\r\n  AWAITING_INPUT,\r\n  GAME_WIN,\r\n  GAME_LOSS,\r\n}\r\n\r\nexport enum Direction {\r\n  UP = \"up\",\r\n  DOWN = \"down\",\r\n  LEFT = \"left\",\r\n  RIGHT = \"right\",\r\n}\r\nconst startingStage = 1;\r\nexport const gameSeed = new Rand.AleaRNG();\r\n\r\ninterface GlobalState {\r\n  stageCount: number;\r\n  stage: Stage;\r\n  posCache: Map<string, Entity[]>;\r\n  playerCache: Entity | undefined;\r\n  help: boolean;\r\n  currentGameState: GameState;\r\n}\r\n\r\nexport const state: GlobalState = {\r\n  // The current level 'depth'\r\n  stageCount: 1,\r\n  // Stores the current level\r\n  stage: selectStage(startingStage),\r\n  // Allows quick lookup of entities.\r\n  // Should not be changed outside the cache system\r\n  posCache: new Map<string, Entity[]>(),\r\n  // Allows quick lookup of player entity.\r\n  // Should not be changed outside the cache system\r\n  playerCache: undefined,\r\n  // Toggle Help Screen\r\n  help: true,\r\n  // The state of the game\r\n  currentGameState: GameState.GAME_START,\r\n};\r\n\r\nexport function restart() {\r\n  Log.addEntryHigh(\"You are reborn. Let the snailing continue!\");\r\n  state.stageCount = 1;\r\n  const newLevel = selectStage(state.stageCount);\r\n  state.stage = newLevel;\r\n  state.currentGameState = GameState.GAME_START;\r\n}\r\n","import { Entity } from './entities';\r\nimport { Util, Vector2 } from 'malwoden';\r\nimport { Terrain } from './terrain';\r\n\r\nexport const map_width = 52;\r\nexport const map_height = 38;\r\n\r\nexport class Stage {\r\n  name: string;\r\n  startPos: Vector2;\r\n  entites: Entity[];\r\n  map: Util.Table<Terrain>;\r\n  fow: boolean;\r\n  fowVisited: Util.Table<boolean>;\r\n\r\n  constructor(\r\n    name: string,\r\n    map: Util.Table<Terrain>,\r\n    entities: Entity[],\r\n    startPos: Vector2,\r\n  ) {\r\n    this.name = name;\r\n    this.map = map;\r\n    this.entites = entities;\r\n    this.startPos = startPos;\r\n    this.fow = true;\r\n    this.fowVisited = new Util.Table(this.map.width, this.map.height);\r\n  }\r\n\r\n  addEntity(e: Entity) {\r\n    this.entites.push(e);\r\n  }\r\n\r\n  removeEntity(e: Entity) {\r\n    this.entites = this.entites.filter((x) => x.id !== e.id);\r\n  }\r\n}\r\n","import { Vector2, Glyph, CharCode, Color, Rand } from \"malwoden\";\r\nimport { Entity } from \"./entities\";\r\n\r\nconst rng = new Rand.AleaRNG();\r\n\r\ninterface EntityOptions {\r\n  position: Vector2;\r\n}\r\n\r\nexport function getBird(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Bird\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    glyph: Glyph.fromCharCode(CharCode.rightwardsArrow, Color.Orange),\r\n    ai: \"chase\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 10,\r\n      maxHp: 10,\r\n      level: 1,\r\n      attack: 4,\r\n      armor: 0,\r\n      exp: 0,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getMantis(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Mantis\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    glyph: Glyph.fromCharCode(CharCode.mUpper, Color.Orange),\r\n    // glyph: Glyph.fromCharCode(CharCode.squareRoot, Color.AliceBlue),\r\n    ai: \"chase\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 3,\r\n      maxHp: 3,\r\n      level: 1,\r\n      attack: 3,\r\n      armor: 2,\r\n      exp: 20,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getWeasle(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Wealse\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    //glyph: Glyph.fromCharCode(CharCode.mUpper, Color.Orange),\r\n    glyph: Glyph.fromCharCode(CharCode.squareRoot, Color.AliceBlue),\r\n    ai: \"chase\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 17,\r\n      maxHp: 17,\r\n      level: 1,\r\n      attack: 8,\r\n      armor: 3,\r\n      exp: 0,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getScorpion(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    //a boss\r\n    name: \"Scorpion\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    //glyph: Glyph.fromCharCode(CharCode.mUpper, Color.Orange),\r\n    glyph: Glyph.fromCharCode(CharCode.poundSign, Color.AliceBlue),\r\n    ai: \"chase\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 10,\r\n      maxHp: 10,\r\n      level: 1,\r\n      attack: 6,\r\n      armor: 3,\r\n      exp: 50,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getAnts(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Ants\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    //glyph: Glyph.fromCharCode(CharCode.mUpper, Color.Orange),\r\n    glyph: Glyph.fromCharCode(CharCode.caret, Color.AliceBlue),\r\n    ai: \"wander\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 6,\r\n      maxHp: 6,\r\n      level: 1,\r\n      attack: 4,\r\n      armor: 3,\r\n      exp: 50,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getSnake(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Snake\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    glyph: Glyph.fromCharCode(CharCode.sUpper, Color.Green),\r\n    ai: \"chase\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 5,\r\n      maxHp: 5,\r\n      level: 1,\r\n      attack: 5,\r\n      armor: 3,\r\n      exp: 70,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getSquirrel(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Squirrel\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    glyph: Glyph.fromCharCode(CharCode.qUpper, Color.IndianRed),\r\n    ai: \"chase\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 10,\r\n      maxHp: 10,\r\n      level: 1,\r\n      attack: 8,\r\n      armor: 4,\r\n      exp: 70,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getRabbit(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Rabbit\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    glyph: Glyph.fromCharCode(CharCode.rUpper, Color.WhiteSmoke),\r\n    ai: \"wander\",\r\n    collision: true,\r\n    vision: 6,\r\n    stats: {\r\n      hp: 8,\r\n      maxHp: 8,\r\n      level: 1,\r\n      attack: 8,\r\n      armor: 3,\r\n      exp: 50,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getLadybug(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Ladybug\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    glyph: Glyph.fromCharCode(CharCode.lUpper, Color.Red),\r\n    ai: \"wander\",\r\n    collision: true,\r\n    stats: {\r\n      hp: 1,\r\n      maxHp: 1,\r\n      level: 1,\r\n      attack: 2,\r\n      armor: 2,\r\n      exp: 10,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getShellGuardian(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Shell Guardian\",\r\n    enemy: true,\r\n    position: options.position,\r\n    renderPriority: 2,\r\n    glyph: Glyph.fromCharCode(CharCode.at, Color.Red),\r\n    ai: \"guard\",\r\n    collision: true,\r\n    stats: {\r\n      hp: 20,\r\n      maxHp: 20,\r\n      level: 1,\r\n      attack: 9,\r\n      armor: 3,\r\n      exp: 70,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getPlayer(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Mal\",\r\n    player: true,\r\n    position: options.position,\r\n    incomingDamage: [],\r\n    renderPriority: 1,\r\n    glyph: Glyph.fromCharCode(CharCode.at, Color.Yellow),\r\n    vision: 7,\r\n    collision: true,\r\n    stats: {\r\n      hp: 15,\r\n      maxHp: 15,\r\n      level: 1,\r\n      attack: 3,\r\n      armor: 1,\r\n      exp: 0,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getStairs(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Stairs\",\r\n    position: options.position,\r\n    renderPriority: 3,\r\n    glyph: Glyph.fromCharCode(CharCode.downwardsArrow, Color.Cyan),\r\n    stairs: true,\r\n  };\r\n}\r\n\r\nexport function getBerry(options: EntityOptions): Entity {\r\n  const amount = rng.nextItem([1, 2]);\r\n  const color = amount === 1 ? Color.LightBlue : Color.Cyan;\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Berry\",\r\n    position: options.position,\r\n    renderPriority: 4,\r\n    glyph: Glyph.fromCharCode(CharCode.bullet, color),\r\n    consumable: {\r\n      hp: amount,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getBook(options: EntityOptions): Entity {\r\n  const amount = rng.nextItem([20, 20, 20, 30, 30, 50]);\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"Snail Book\",\r\n    position: options.position,\r\n    renderPriority: 4,\r\n    glyph: Glyph.fromCharCode(CharCode.equals, Color.Brown),\r\n    consumable: {\r\n      exp: amount,\r\n    },\r\n  };\r\n}\r\n\r\nexport function getMysticShell(options: EntityOptions): Entity {\r\n  return {\r\n    id: Math.random().toString(),\r\n    name: \"The Mystic Shell!\",\r\n    position: options.position,\r\n    renderPriority: 4,\r\n    glyph: Glyph.fromCharCode(CharCode.at, Color.MediumPurple),\r\n    consumable: {\r\n      winCondition: true,\r\n    },\r\n  };\r\n}\r\n\r\n//traps\r\n","import { Util } from \"malwoden\";\r\n\r\nexport function strokeTable<T>(table: Util.Table<T>, val: T) {\r\n  for (let x = 0; x < table.width; x++) {\r\n    for (let y = 0; y < table.height; y++) {\r\n      if (\r\n        x === 0 ||\r\n        x === table.width - 1 ||\r\n        y === 0 ||\r\n        y === table.height - 1\r\n      ) {\r\n        table.set({ x, y }, val);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import * as Prefab from \"../prefabs\";\r\nimport { Stage } from \"../stage\";\r\nimport { Generation, Rand, Vector2 } from \"malwoden\";\r\nimport { Terrain } from \"../terrain\";\r\nimport { strokeTable } from \"./helpers\";\r\nimport { Entity } from \"../entities\";\r\n\r\ninterface Stage1Config {\r\n  name: string;\r\n  enemies: number;\r\n  berries: number;\r\n  books: number;\r\n}\r\nexport function generateStage1(\r\n  width: number,\r\n  height: number,\r\n  createPlayer: boolean,\r\n  config: Stage1Config\r\n): Stage {\r\n  //generate seed\r\n  // Generate Terrain\r\n  const map_width = width;\r\n  const map_height = height;\r\n  const map = new Generation.CellularAutomata<Terrain>(map_width, map_height, {\r\n    aliveValue: Terrain.tree,\r\n    deadValue: Terrain.none,\r\n  });\r\n  map.randomize(0.63);\r\n  map.doSimulationStep(3);\r\n  map.connect();\r\n  strokeTable(map.table, Terrain.tree);\r\n\r\n  const open: Vector2[] = [];\r\n  for (let x = 0; x < map.table.width; x++) {\r\n    for (let y = 0; y < map.table.height; y++) {\r\n      if (map.table.get({ x, y }) === 0) open.push({ x, y });\r\n    }\r\n  }\r\n  const rng = new Rand.AleaRNG();\r\n  const randomOpen = rng.shuffle(open);\r\n  const entities: Entity[] = [];\r\n\r\n  let rngPos = 0;\r\n\r\n  const startPos = randomOpen[rngPos++];\r\n  // Generate Player if applicable, start pos either way\r\n  if (createPlayer) {\r\n    entities.push(Prefab.getPlayer({ position: startPos }));\r\n  }\r\n\r\n  // Generate Stairs\r\n  entities.push(Prefab.getStairs({ position: randomOpen[rngPos++] }));\r\n\r\n  // Generate Entities\r\n  for (let i = 0; i < config.enemies; i++) {\r\n    let e = rng.nextBoolean()\r\n      ? Prefab.getMantis({ position: randomOpen[rngPos++] })\r\n      : Prefab.getLadybug({ position: randomOpen[rngPos++] });\r\n    entities.push(e);\r\n  }\r\n\r\n  // Generate berries\r\n  for (let i = 0; i < config.berries; i++) {\r\n    const berry = Prefab.getBerry({ position: randomOpen[rngPos++] });\r\n    entities.push(berry);\r\n  }\r\n  // Generate book\r\n  for (let i = 0; i < config.books; i++) {\r\n    const book = Prefab.getBook({ position: randomOpen[rngPos++] });\r\n    entities.push(book);\r\n  }\r\n\r\n  // Create level\r\n  return new Stage(config.name, map.table, entities, startPos);\r\n}\r\n","import * as Prefab from '../prefabs';\r\nimport { Stage } from '../stage';\r\nimport { Generation, Rand, Vector2 } from 'malwoden';\r\nimport { Terrain } from '../terrain';\r\nimport { strokeTable } from './helpers';\r\nimport { Entity } from '../entities';\r\n\r\ninterface Stage2Config {\r\n  name: string;\r\n  enemies: number;\r\n  scorpions: number;\r\n  berries: number;\r\n  books: number;\r\n}\r\n\r\nexport function generateStage2(\r\n  width: number,\r\n  height: number,\r\n  createPlayer: boolean,\r\n  config: Stage2Config,\r\n): Stage {\r\n  //generate seed\r\n  // Generate Terrain\r\n  const map_width = width;\r\n  const map_height = height;\r\n  const map = new Generation.DrunkardsWalk({\r\n    width: map_width,\r\n    height: map_height,\r\n    topology: 'four',\r\n  });\r\n  map.walkSteps({\r\n    steps: Infinity,\r\n    maxCoveredTiles: 1000,\r\n  });\r\n  for (let x = 0; x < map.table.width; x++) {\r\n    for (let y = 0; y < map.table.height; y++) {\r\n      const val = map.table.get({ x, y });\r\n      map.table.set({ x, y }, val ? Terrain.none : Terrain.mountain);\r\n    }\r\n  }\r\n  strokeTable(map.table, Terrain.mountain);\r\n\r\n  const open: Vector2[] = [];\r\n  for (let x = 0; x < map.table.width; x++) {\r\n    for (let y = 0; y < map.table.height; y++) {\r\n      if (map.table.get({ x, y }) === 0) open.push({ x, y });\r\n    }\r\n  }\r\n  const rng = new Rand.AleaRNG();\r\n  const randomOpen = rng.shuffle(open);\r\n  const entities: Entity[] = [];\r\n  let rngPos = 0;\r\n\r\n  // Generate Player if applicable, start pos either way\r\n  const startPos = randomOpen[rngPos++];\r\n  if (createPlayer) {\r\n    entities.push(Prefab.getPlayer({ position: startPos }));\r\n  }\r\n  // Generate Stairs\r\n  entities.push(Prefab.getStairs({ position: randomOpen[rngPos++] }));\r\n\r\n  // Generate Entities\r\n  for (let i = 0; i < config.enemies; i++) {\r\n    let e = rng.nextItem([\r\n      Prefab.getAnts({ position: randomOpen[rngPos++] }),\r\n      Prefab.getAnts({ position: randomOpen[rngPos++] }),\r\n      Prefab.getSnake({ position: randomOpen[rngPos++] }),\r\n    ])!;\r\n    entities.push(e);\r\n  }\r\n\r\n  // Generate scorpions\r\n  for (let i = 0; i < config.scorpions; i++) {\r\n    entities.push(Prefab.getScorpion({ position: randomOpen[rngPos++] }));\r\n  }\r\n\r\n  // Generate berries\r\n  for (let i = 0; i < config.berries; i++) {\r\n    const berry = Prefab.getBerry({ position: randomOpen[rngPos++] });\r\n    entities.push(berry);\r\n  }\r\n\r\n  // Generate book\r\n  for (let i = 0; i < config.books; i++) {\r\n    const book = Prefab.getBook({ position: randomOpen[rngPos++] });\r\n    entities.push(book);\r\n  }\r\n\r\n  // Create level\r\n  return new Stage(config.name, map.table, entities, startPos);\r\n}\r\n","import * as Prefab from \"../prefabs\";\r\nimport { Stage } from \"../stage\";\r\nimport { Generation, Rand, Vector2 } from \"malwoden\";\r\nimport { Terrain } from \"../terrain\";\r\nimport { strokeTable } from \"./helpers\";\r\nimport { Entity } from \"../entities\";\r\n\r\ninterface Stage3Config {\r\n  name: string;\r\n  enemies: number;\r\n  berries: number;\r\n  books: number;\r\n  mysticShell: boolean;\r\n}\r\nexport function generateStage3(\r\n  width: number,\r\n  height: number,\r\n  createPlayer: boolean,\r\n  config: Stage3Config\r\n): Stage {\r\n  //generate seed\r\n  // Generate Terrain\r\n  const map_width = width;\r\n  const map_height = height;\r\n  const map = new Generation.CellularAutomata<Terrain>(map_width, map_height, {\r\n    aliveValue: Terrain.tree,\r\n    deadValue: Terrain.none,\r\n  });\r\n  map.randomize(0.63);\r\n  map.doSimulationStep(3);\r\n  map.connect();\r\n  strokeTable(map.table, Terrain.tree);\r\n\r\n  const rng = new Rand.AleaRNG();\r\n\r\n  // Replace trees with random mushrooms\r\n  for (let x = 0; x < map.table.width; x++) {\r\n    for (let y = 0; y < map.table.height; y++) {\r\n      const isTree = map.table.get({ x, y }) === Terrain.tree;\r\n      if (!isTree) continue;\r\n      const next = rng.nextItem([0, 1, 2, 3])!;\r\n      switch (next) {\r\n        case 0:\r\n          break;\r\n        case 1:\r\n          map.table.set({ x, y }, Terrain.mushroomRed);\r\n          break;\r\n        case 2:\r\n          map.table.set({ x, y }, Terrain.mushroomPurple);\r\n          break;\r\n        case 3:\r\n          map.table.set({ x, y }, Terrain.mushroomDarkPurple);\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  const open: Vector2[] = [];\r\n  for (let x = 0; x < map.table.width; x++) {\r\n    for (let y = 0; y < map.table.height; y++) {\r\n      if (map.table.get({ x, y }) === 0) open.push({ x, y });\r\n    }\r\n  }\r\n  const randomOpen = rng.shuffle(open);\r\n  const entities: Entity[] = [];\r\n\r\n  let rngPos = 0;\r\n\r\n  const startPos = randomOpen[rngPos++];\r\n  // Generate Player if applicable, start pos either way\r\n  if (createPlayer) {\r\n    entities.push(Prefab.getPlayer({ position: startPos }));\r\n  }\r\n\r\n  // Generate Stairs\r\n  if (!config.mysticShell) {\r\n    entities.push(Prefab.getStairs({ position: randomOpen[rngPos++] }));\r\n  }\r\n\r\n  // Generate Entities\r\n  for (let i = 0; i < config.enemies; i++) {\r\n    let e = rng.nextBoolean()\r\n      ? Prefab.getSquirrel({ position: randomOpen[rngPos++] })\r\n      : Prefab.getRabbit({ position: randomOpen[rngPos++] });\r\n    entities.push(e);\r\n  }\r\n\r\n  // Generate berries\r\n  for (let i = 0; i < config.berries; i++) {\r\n    const berry = Prefab.getBerry({ position: randomOpen[rngPos++] });\r\n    entities.push(berry);\r\n  }\r\n  // Generate book\r\n  for (let i = 0; i < config.books; i++) {\r\n    const book = Prefab.getBook({ position: randomOpen[rngPos++] });\r\n    entities.push(book);\r\n  }\r\n\r\n  // Generate mystic shell\r\n  if (config.mysticShell) {\r\n    const shellPos = randomOpen[rngPos++];\r\n    const clearPos = (pos: Vector2) => {\r\n      if (map.table.isInBounds(pos)) {\r\n        map.table.set(pos, Terrain.none);\r\n      }\r\n    };\r\n    // Clear the area\r\n    for (let x = -3; x <= 3; x++) {\r\n      for (let y = -3; y <= 3; y++) {\r\n        const pos = { x: shellPos.x + x, y: shellPos.y + y };\r\n        clearPos(pos);\r\n      }\r\n    }\r\n\r\n    const walls = [\r\n      { x: shellPos.x + 2, y: shellPos.y - 1 },\r\n      { x: shellPos.x + 2, y: shellPos.y - 2 },\r\n      { x: shellPos.x + 1, y: shellPos.y - 2 },\r\n      { x: shellPos.x - 1, y: shellPos.y - 2 },\r\n      { x: shellPos.x - 2, y: shellPos.y - 2 },\r\n      { x: shellPos.x - 2, y: shellPos.y - 1 },\r\n      { x: shellPos.x - 2, y: shellPos.y + 1 },\r\n      { x: shellPos.x - 2, y: shellPos.y + 2 },\r\n      { x: shellPos.x - 1, y: shellPos.y + 2 },\r\n      { x: shellPos.x + 1, y: shellPos.y + 2 },\r\n      { x: shellPos.x + 2, y: shellPos.y + 2 },\r\n      { x: shellPos.x + 2, y: shellPos.y + 1 },\r\n    ];\r\n\r\n    const doors = [\r\n      { x: shellPos.x + 2, y: shellPos.y - 0 },\r\n      { x: shellPos.x + 0, y: shellPos.y - 2 },\r\n      { x: shellPos.x - 2, y: shellPos.y - 0 },\r\n      { x: shellPos.x - 0, y: shellPos.y + 2 },\r\n    ];\r\n\r\n    entities.push(Prefab.getMysticShell({ position: shellPos }));\r\n\r\n    for (let w of walls) {\r\n      if (map.table.isInBounds(w)) {\r\n        map.table.set(w, Terrain.wall);\r\n      }\r\n    }\r\n\r\n    for (let d of doors) {\r\n      clearPos(d);\r\n      entities.push(Prefab.getShellGuardian({ position: d }));\r\n    }\r\n  }\r\n\r\n  // Create level\r\n  return new Stage(config.name, map.table, entities, startPos);\r\n}\r\n","import { map_height, map_width, Stage } from \"../stage\";\r\n\r\nimport { generateStage1 } from \"./stage-1\";\r\nimport { generateStage2 } from \"./stage-2\";\r\nimport { generateStage3 } from \"./stage-3\";\r\n\r\nexport function selectStage(stage: number): Stage {\r\n  switch (stage) {\r\n    case 1:\r\n      return generateStage1(map_width, map_height, true, {\r\n        name: \"The Short Grass\",\r\n        enemies: 7,\r\n        books: 1,\r\n        berries: 5,\r\n      });\r\n    case 2:\r\n      return generateStage1(map_width, map_height, false, {\r\n        name: \"The Tall Grass\",\r\n        enemies: 10,\r\n        books: 1,\r\n        berries: 5,\r\n      });\r\n    case 3:\r\n      return generateStage2(map_width, map_height, false, {\r\n        name: \"The Gravel Path\",\r\n        enemies: 10,\r\n        scorpions: 0,\r\n        berries: 9,\r\n        books: 1,\r\n      });\r\n    case 4:\r\n      return generateStage2(map_width, map_height, false, {\r\n        name: \"The Scorpion Den\",\r\n        enemies: 3,\r\n        scorpions: 7,\r\n        berries: 9,\r\n        books: 2,\r\n      });\r\n    case 5:\r\n      return generateStage3(map_width, map_height, false, {\r\n        name: \"The Mushroom Patch\",\r\n        enemies: 7,\r\n        berries: 10,\r\n        books: 2,\r\n        mysticShell: false,\r\n      });\r\n    case 6:\r\n      return generateStage3(map_width, map_height, false, {\r\n        name: \"Shrine of the Mystic Shell\",\r\n        enemies: 7,\r\n        berries: 10,\r\n        books: 2,\r\n        mysticShell: true,\r\n      });\r\n  }\r\n  throw new Error(\"Stage ID not recognized!\");\r\n}\r\n","import { Stage } from \"../stage\";\r\nimport { Log } from \"../logs\";\r\n\r\nexport function getEXPForLevel(level: number) {\r\n  return ((level * (level + 1)) / 2) * 100;\r\n}\r\nexport class LevelSystem {\r\n  loop(stage: Stage) {\r\n    const player = stage.entites.find((x) => x.player);\r\n    if (player && player.stats) {\r\n      const level = player.stats.level;\r\n      const exp = player.stats.exp;\r\n      const equa = getEXPForLevel(level);\r\n      if (equa <= exp) {\r\n        // this should generate a random chance at stats later down the line to provide a more mixed play. Or let the player choose the stats.\r\n        Log.addEntryHigh(\"You have leveled up!\");\r\n        const bonus = Math.round(Math.random());\r\n        player.stats.hp = player.stats.hp + 2 + bonus;\r\n        player.stats.maxHp = player.stats.maxHp + 2 + bonus;\r\n        player.stats.attack = player.stats.attack + 1;\r\n        player.stats.armor = player.stats.armor + 1;\r\n        player.stats.level = player.stats.level + 1;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Terminal, GUI, Input, Color, CharCode, Vector2 } from \"malwoden\";\r\nimport { Stage } from \"../stage\";\r\nimport { FOWTerrainGlyphs, TerrainGlyphs } from \"../terrain\";\r\nimport { Log, LogLevel } from \"../logs\";\r\nimport { GameState, state } from \"../globals\";\r\nimport { Entity } from \"../entities\";\r\nimport { getEXPForLevel } from \"./levelSystem\";\r\n\r\ninterface RenderSystemContext {\r\n  stage: Stage;\r\n  terminal: Terminal.RetroTerminal;\r\n  mapTerminal: Terminal.PortTerminal;\r\n}\r\n\r\nconst logLevelColor: { [l in LogLevel]: Color } = {\r\n  high: Color.Cyan,\r\n  mid: Color.White,\r\n  low: Color.Gray,\r\n  warning: Color.Red,\r\n};\r\n\r\nexport class RenderSystem {\r\n  mouse = new Input.MouseHandler();\r\n\r\n  loop({ terminal, mapTerminal }: RenderSystemContext) {\r\n    // Rendering\r\n    terminal.clear();\r\n    const player = state.stage.entites.find((x) => x.player);\r\n    const playerViewshed = player?.viewShed?.area || new Map<string, Vector2>();\r\n\r\n    // Player Box\r\n    GUI.box(terminal, {\r\n      title: \"Player\",\r\n      origin: { x: 0, y: 0 },\r\n      width: 15,\r\n      height: 20,\r\n    });\r\n    if (player) {\r\n      if (player.stats) {\r\n        terminal.writeAt(\r\n          { x: 2, y: 2 },\r\n          `HP: ${player.stats.hp}/${player.stats.maxHp}`\r\n        );\r\n        drawBar(\r\n          terminal,\r\n          { x: 2, y: 3 },\r\n          10,\r\n          player.stats.hp / player.stats.maxHp,\r\n          Color.Red\r\n        );\r\n        const expNext = getEXPForLevel(player.stats.level);\r\n        const expLast = getEXPForLevel(player.stats.level - 1);\r\n        const lvlExp = expNext - expLast;\r\n        const curExp = player.stats.exp - expLast;\r\n        terminal.writeAt({ x: 2, y: 5 }, `EXP`);\r\n        drawBar(terminal, { x: 2, y: 6 }, 10, curExp / lvlExp, Color.Gold);\r\n\r\n        terminal.writeAt({ x: 2, y: 9 }, `Level:  ${player.stats.level}`);\r\n        terminal.writeAt({ x: 2, y: 10 }, `Attack: ${player.stats.attack}`);\r\n        terminal.writeAt({ x: 2, y: 11 }, `Armor:  ${player.stats.armor}`);\r\n      }\r\n    }\r\n\r\n    terminal.writeAt({ x: 2, y: 18 }, \"(h) help\");\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Logs\r\n    // -------------------------------------------------------------------------\r\n    GUI.box(terminal, {\r\n      title: \"Log\",\r\n      origin: { x: 16, y: 40 },\r\n      width: 53,\r\n      height: 9,\r\n    });\r\n\r\n    for (let i = 0; i < Log.length(); i++) {\r\n      const [logLevel, txt] = Log.entries[i];\r\n      const logColor = logLevelColor[logLevel];\r\n      terminal.writeAt({ x: 17, y: 41 + i }, txt, logColor);\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Draw World\r\n    // -------------------------------------------------------------------------\r\n    GUI.box(terminal, {\r\n      origin: { x: 16, y: 0 },\r\n      width: 53,\r\n      height: 39,\r\n    });\r\n    terminal.writeAt(\r\n      { x: 17, y: 0 },\r\n      ` Stage ${state.stageCount} | ${state.stage.name} `\r\n    );\r\n\r\n    for (let x = 0; x < state.stage.map.width; x++) {\r\n      for (let y = 0; y < state.stage.map.height; y++) {\r\n        const v = { x, y };\r\n        const terrain = state.stage.map.get({ x, y });\r\n\r\n        const isVisible =\r\n          state.stage.fowVisited.isInBounds(v) && state.stage.fowVisited.get(v);\r\n\r\n        if (!isVisible) {\r\n          mapTerminal.drawCharCode(\r\n            v,\r\n            CharCode.blackSquare,\r\n            Color.DimGray.blendPercent(Color.Black, 70),\r\n            Color.DimGray.blendPercent(Color.Black, 70)\r\n          );\r\n          continue;\r\n        }\r\n\r\n        // Draw FOW Terrain\r\n        if (terrain !== undefined) {\r\n          const glyph = FOWTerrainGlyphs[terrain];\r\n          if (glyph) {\r\n            mapTerminal.drawGlyph({ x, y }, glyph);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Calculate for player's viewshed\r\n\r\n    const entitiesInSight: Entity[] = [];\r\n    playerViewshed.forEach((pos) => {\r\n      const terrain = state.stage.map.get(pos);\r\n      const entities = state.posCache.get(`${pos.x}:${pos.y}`) || [];\r\n      entitiesInSight.push(...entities);\r\n\r\n      // Draw Revealed Terrain\r\n      if (terrain !== undefined) {\r\n        const glyph = TerrainGlyphs[terrain];\r\n        if (glyph) {\r\n          mapTerminal.drawGlyph(pos, glyph);\r\n        }\r\n      }\r\n      // Draw entities\r\n      if (entities?.length) {\r\n        const sortedEntities = entities.sort(\r\n          (a, b) => b.renderPriority - a.renderPriority\r\n        );\r\n        for (let e of sortedEntities) {\r\n          mapTerminal.drawGlyph(e.position, e.glyph);\r\n        }\r\n      }\r\n    });\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Info Box\r\n    // -------------------------------------------------------------------------\r\n    GUI.box(terminal, {\r\n      title: \"Info\",\r\n      origin: { x: 0, y: 21 },\r\n      width: 15,\r\n      height: 28,\r\n    });\r\n\r\n    // Info HP\r\n    const infoEntities = entitiesInSight\r\n      .filter((x) => x.enemy && x.stats) // Only get enemies with stats\r\n      .sort((a, b) => a.id.localeCompare(b.id)); // Sort to make sure we always render the same order\r\n\r\n    for (let i = 0; i < Math.min(infoEntities.length, 5); i++) {\r\n      const e = infoEntities[i];\r\n      const y = 23 + i * 3;\r\n      terminal.writeAt({ x: 2, y: y }, e.name);\r\n      drawBar(\r\n        terminal,\r\n        { x: 2, y: y + 1 },\r\n        10,\r\n        e.stats!.hp / e.stats!.maxHp,\r\n        e.glyph.fore\r\n      );\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Labels\r\n    // -------------------------------------------------------------------------\r\n    const mousePos = this.mouse.getPos();\r\n    const termPos = terminal.pixelToChar(mousePos);\r\n\r\n    // Offset for portTerminal\r\n\r\n    // World Position offset for port terminal\r\n    const worldPos = {\r\n      x: termPos.x - 17,\r\n      y: termPos.y - 1,\r\n    };\r\n\r\n    // Only draw the label if the player can see it\r\n    if (player?.viewShed?.area.has(`${worldPos.x}:${worldPos.y}`)) {\r\n      // console.log(worldPos);\r\n      const selectedEntities = state.posCache.get(\r\n        `${worldPos.x}:${worldPos.y}`\r\n      );\r\n      if (selectedEntities?.length) {\r\n        drawLabel(terminal, termPos, selectedEntities[0].name);\r\n      }\r\n    }\r\n\r\n    if (state.currentGameState === GameState.GAME_WIN) {\r\n      renderWon(mapTerminal);\r\n    }\r\n    if (state.currentGameState === GameState.GAME_LOSS) {\r\n      renderLost(mapTerminal);\r\n    }\r\n    // Render Help\r\n    if (state.help) {\r\n      renderHelp(terminal);\r\n    }\r\n\r\n    // Render Terminal\r\n    terminal.render();\r\n  }\r\n}\r\n\r\nfunction drawBar(\r\n  terminal: Terminal.BaseTerminal,\r\n  pos: Vector2,\r\n  width: number,\r\n  percent: number,\r\n  color: Color\r\n) {\r\n  const filledWidth = Math.floor(width * percent);\r\n\r\n  for (let x = 0; x < width; x++) {\r\n    const isFilled = x <= filledWidth;\r\n    const c = isFilled ? color : color.blend(Color.Black);\r\n    terminal.drawCharCode(\r\n      { x: pos.x + x, y: pos.y },\r\n      CharCode.blackSquare,\r\n      c,\r\n      c\r\n    );\r\n  }\r\n}\r\n\r\nfunction drawLabel(\r\n  terminal: Terminal.BaseTerminal,\r\n  pos: Vector2,\r\n  text: string\r\n) {\r\n  if (pos.x < 50) {\r\n    const textPos = { x: pos.x + 3, y: pos.y };\r\n    terminal.drawCharCode(\r\n      { x: pos.x + 1, y: pos.y },\r\n      CharCode.leftwardsArrow,\r\n      Color.DarkSlateGray,\r\n      Color.White\r\n    );\r\n    terminal.drawCharCode(\r\n      { x: pos.x + 2, y: pos.y },\r\n      CharCode.blackSquare,\r\n      Color.White,\r\n      Color.DarkSlateGray\r\n    );\r\n    terminal.writeAt(textPos, text, Color.White, Color.DarkSlateGray);\r\n  } else {\r\n    terminal.drawCharCode(\r\n      {\r\n        x: pos.x - 1,\r\n        y: pos.y,\r\n      },\r\n      CharCode.rightwardsArrow,\r\n      Color.DarkSlateGray,\r\n      Color.White\r\n    );\r\n    terminal.drawCharCode(\r\n      {\r\n        x: pos.x - 2,\r\n        y: pos.y,\r\n      },\r\n      CharCode.blackSquare,\r\n      Color.White,\r\n      Color.DarkSlateGray\r\n    );\r\n    const textPos = { x: pos.x - 2 - text.length, y: pos.y };\r\n    terminal.writeAt(textPos, text, Color.White, Color.DarkSlateGray);\r\n  }\r\n}\r\n\r\nfunction renderHelp(terminal: Terminal.BaseTerminal) {\r\n  GUI.box(terminal, {\r\n    origin: { x: 2, y: 2 },\r\n    width: 65,\r\n    height: 45,\r\n    title: \"Help\",\r\n  });\r\n\r\n  // Intro Start X/Y\r\n  const isX = 5;\r\n  const isY = 6;\r\n\r\n  terminal.writeAt({ x: isX, y: isY }, \"Help\");\r\n  terminal.writeAt({ x: isX + 5, y: isY }, \"Mal the Snail\", Color.Yellow);\r\n  terminal.writeAt({ x: isX + 19, y: isY }, \"travel through the garden,\");\r\n\r\n  terminal.writeAt({ x: isX, y: isY + 2 }, \"and retrieve the \");\r\n  terminal.writeAt(\r\n    { x: isX + 17, y: isY + 2 },\r\n    \"Mystic Shell\",\r\n    Color.MediumPurple\r\n  );\r\n  terminal.writeAt({ x: isX + 29, y: isY + 2 }, \".\");\r\n\r\n  // Controls\r\n\r\n  const cX = 5;\r\n  const cY = 12;\r\n  terminal.writeAt({ x: cX, y: cY }, \"-- Controls --\", Color.Cyan);\r\n  terminal.writeAt({ x: cX, y: cY + 2 }, \"- Use     to move.\");\r\n  terminal.writeAt({ x: cX, y: cY + 4 }, \"- Use (Space) to skip a turn.\");\r\n  terminal.writeAt(\r\n    { x: cX, y: cY + 6 },\r\n    \"- Move into an enemy to attack them.\"\r\n  );\r\n  terminal.writeAt(\r\n    { x: cX, y: cY + 8 },\r\n    \"- Hover over objects to see a description.\"\r\n  );\r\n\r\n  // Quit\r\n  const qX = 47;\r\n  const qY = 45;\r\n  terminal.writeAt({ x: qX, y: qY }, \"Press (esc) to \");\r\n  terminal.writeAt({ x: qX + 15, y: qY }, \"@_,\", Color.Yellow);\r\n}\r\n\r\nconst winAnim = {\r\n  faceRight: true,\r\n  dX: 0,\r\n};\r\n\r\nsetInterval(() => {\r\n  if (state.currentGameState !== GameState.GAME_WIN) {\r\n    winAnim.faceRight = true;\r\n    winAnim.dX = 0;\r\n    return;\r\n  }\r\n  if (winAnim.faceRight) {\r\n    if (winAnim.dX < 25) {\r\n      winAnim.dX++;\r\n    } else {\r\n      winAnim.faceRight = false;\r\n    }\r\n  } else {\r\n    if (winAnim.dX > 0) {\r\n      winAnim.dX--;\r\n    } else {\r\n      winAnim.faceRight = true;\r\n    }\r\n  }\r\n}, 150);\r\n\r\nfunction renderWon(terminal: Terminal.PortTerminal) {\r\n  terminal.clear();\r\n\r\n  const wX = 12;\r\n  const wY = 15;\r\n\r\n  terminal.writeAt({ x: wX, y: wY }, \"Mal\", Color.Yellow);\r\n  terminal.writeAt({ x: wX + 4, y: wY }, \"found the\");\r\n  terminal.writeAt({ x: wX + 14, y: wY }, \"Mystic Shell!\", Color.MediumPurple);\r\n\r\n  const mX = 12;\r\n  const mY = 10;\r\n\r\n  if (winAnim.faceRight) {\r\n    terminal.writeAt({ x: mX + winAnim.dX, y: mY }, \"@\", Color.MediumPurple);\r\n    terminal.writeAt({ x: mX + 1 + winAnim.dX, y: mY }, \"_,\", Color.Yellow);\r\n  } else {\r\n    terminal.writeAt({ x: mX - 3 + winAnim.dX, y: mY }, \",_\", Color.Yellow);\r\n    terminal.writeAt(\r\n      { x: mX - 1 + winAnim.dX, y: mY },\r\n      \"@\",\r\n      Color.MediumPurple\r\n    );\r\n  }\r\n\r\n  terminal.writeAt(\r\n    { x: 5, y: 20 },\r\n    \"With the shell's wisdom, the snail kingdom\"\r\n  );\r\n  terminal.writeAt({ x: 7, y: 22 }, \"would propser under a new golden age.\");\r\n  terminal.writeAt({ x: 12, y: 26 }, \"Not the fastest golden age,\");\r\n  terminal.writeAt({ x: 15, y: 28 }, \"but good nonetheless.\");\r\n\r\n  // Quit\r\n  const qX = 25;\r\n  const qY = 35;\r\n  terminal.writeAt({ x: qX, y: qY }, \"Press (esc) to \");\r\n  terminal.writeAt({ x: qX + 15, y: qY }, \"@_,\", Color.Yellow);\r\n  terminal.writeAt({ x: qX + 19, y: qY }, \"again!\");\r\n}\r\n\r\nfunction renderLost(terminal: Terminal.PortTerminal) {\r\n  terminal.clear();\r\n\r\n  const wX = 20;\r\n  const wY = 15;\r\n\r\n  terminal.writeAt({ x: wX, y: wY }, \"Mal\", Color.Yellow);\r\n  terminal.writeAt({ x: wX + 4, y: wY }, \"has\");\r\n  terminal.writeAt({ x: wX + 8, y: wY }, \"Died!\", Color.Red);\r\n\r\n  const mX = 24;\r\n  const mY = 10;\r\n\r\n  terminal.writeAt({ x: mX + winAnim.dX, y: mY }, \"@_,\", Color.Red);\r\n\r\n  // Quit\r\n  const qX = 25;\r\n  const qY = 35;\r\n  terminal.writeAt({ x: qX, y: qY }, \"Press (esc) to \");\r\n  terminal.writeAt({ x: qX + 15, y: qY }, \"@_,\", Color.Yellow);\r\n  terminal.writeAt({ x: qX + 19, y: qY }, \"again!\");\r\n}\r\n","import { Input } from \"malwoden\";\r\nimport { Direction, GameState, restart } from \"../globals\";\r\nimport { Stage } from \"../stage\";\r\nimport { state } from \"../globals\";\r\n\r\nenum PlayerInput {\r\n  NONE,\r\n  UP,\r\n  DOWN,\r\n  LEFT,\r\n  RIGHT,\r\n  SPACE,\r\n  ESC,\r\n  HELP,\r\n}\r\n\r\nexport class InputSystem {\r\n  currentPlayerInput: PlayerInput = PlayerInput.NONE;\r\n\r\n  constructor() {\r\n    const keyboard = new Input.KeyboardHandler();\r\n    const movement = new Input.KeyboardContext()\r\n      .onDown(\r\n        Input.KeyCode.DownArrow,\r\n        () => (this.currentPlayerInput = PlayerInput.DOWN)\r\n      )\r\n      .onDown(\r\n        Input.KeyCode.LeftArrow,\r\n        () => (this.currentPlayerInput = PlayerInput.LEFT)\r\n      )\r\n      .onDown(\r\n        Input.KeyCode.RightArrow,\r\n        () => (this.currentPlayerInput = PlayerInput.RIGHT)\r\n      )\r\n      .onDown(\r\n        Input.KeyCode.UpArrow,\r\n        () => (this.currentPlayerInput = PlayerInput.UP)\r\n      )\r\n      .onDown(\r\n        Input.KeyCode.Space,\r\n        () => (this.currentPlayerInput = PlayerInput.SPACE)\r\n      )\r\n      .onDown(\r\n        Input.KeyCode.Escape,\r\n        () => (this.currentPlayerInput = PlayerInput.ESC)\r\n      )\r\n      .onDown(\r\n        Input.KeyCode.H,\r\n        () => (this.currentPlayerInput = PlayerInput.HELP)\r\n      );\r\n\r\n    keyboard.setContext(movement);\r\n  }\r\n\r\n  // Returns true if player input was detected\r\n  loop(stage: Stage): boolean {\r\n    if (this.currentPlayerInput === PlayerInput.NONE) return false;\r\n    const player = stage.entites.find((x) => x.player)!;\r\n\r\n    let wasInput = false;\r\n\r\n    if (this.currentPlayerInput === PlayerInput.HELP) {\r\n      state.help = true;\r\n      wasInput = false;\r\n    }\r\n    if (this.currentPlayerInput === PlayerInput.ESC) {\r\n      if (state.help) {\r\n        state.help = false;\r\n      }\r\n      if (\r\n        state.currentGameState === GameState.GAME_WIN ||\r\n        state.currentGameState === GameState.GAME_LOSS\r\n      ) {\r\n        restart();\r\n      }\r\n      wasInput = false;\r\n    } else if (this.currentPlayerInput === PlayerInput.SPACE) {\r\n      // Normal Movement!\r\n      // Space to wait\r\n      wasInput = true;\r\n    } else if (this.currentPlayerInput === PlayerInput.UP) {\r\n      // Direction Keys\r\n      player.wantsToMove = Direction.UP;\r\n      wasInput = true;\r\n    } else if (this.currentPlayerInput === PlayerInput.DOWN) {\r\n      player.wantsToMove = Direction.DOWN;\r\n      wasInput = true;\r\n    } else if (this.currentPlayerInput === PlayerInput.RIGHT) {\r\n      player.wantsToMove = Direction.RIGHT;\r\n      wasInput = true;\r\n    } else if (this.currentPlayerInput === PlayerInput.LEFT) {\r\n      player.wantsToMove = Direction.LEFT;\r\n      wasInput = true;\r\n    }\r\n\r\n    // Make sure we reset the player input\r\n    this.currentPlayerInput = PlayerInput.NONE;\r\n    return wasInput;\r\n  }\r\n}\r\n","import { Vector2 } from \"malwoden\";\r\nimport { Direction, state } from \"../globals\";\r\nimport { Stage } from \"../stage\";\r\nimport { TerrainCollision } from \"../terrain\";\r\nimport { Entity } from \"../entities\";\r\nimport { dealDamage } from \"../damageFunction\";\r\n\r\nconst directionVectors = {\r\n  [Direction.UP]: { x: 0, y: -1 },\r\n  [Direction.DOWN]: { x: 0, y: 1 },\r\n  [Direction.LEFT]: { x: -1, y: 0 },\r\n  [Direction.RIGHT]: { x: 1, y: 0 },\r\n};\r\n\r\nexport class MovementSystem {\r\n  loop(stage: Stage) {\r\n    //sets up monsters that can be collided with.\r\n    for (let e of stage.entites) {\r\n      if (e.wantsToMove) {\r\n        // Get direction, the reset wants to move\r\n        const direction = directionVectors[e.wantsToMove];\r\n        e.wantsToMove = undefined;\r\n\r\n        //where e wants to go.\r\n        const stepPos: Vector2 = {\r\n          x: e.position.x + direction.x,\r\n          y: e.position.y + direction.y,\r\n        };\r\n\r\n        // Check entities\r\n        const stepEntities =\r\n          state.posCache.get(`${stepPos.x}:${stepPos.y}`) || [];\r\n        const entitiesBlocking = stepEntities.some((x) => x.collision);\r\n        if (entitiesBlocking) {\r\n          // Check combat\r\n          this.checkCombat(e, stepEntities);\r\n          continue;\r\n        }\r\n\r\n        // Check terrain\r\n        const terrain = stage.map.get(stepPos);\r\n        const terrainBlocking = terrain ? TerrainCollision[terrain] : false;\r\n        if (terrainBlocking) {\r\n          continue;\r\n        }\r\n\r\n        // Nothing blocking, adjust position\r\n        e.position.x += direction.x;\r\n        e.position.y += direction.y;\r\n\r\n        // Recalculate view if necessary\r\n        if (e.vision && e.viewShed) {\r\n          e.viewShed.dirty = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Converts a movement into a melee attack if applicable\r\n  checkCombat(currentEntity: Entity, blockingEntities: Entity[]) {\r\n    const otherFactionEntity = blockingEntities.find(\r\n      (x) => x.enemy !== currentEntity.enemy && x.stats\r\n    );\r\n\r\n    if (otherFactionEntity && otherFactionEntity.stats) {\r\n      dealDamage(currentEntity, otherFactionEntity);\r\n    }\r\n  }\r\n}\r\n","import { Terminal } from \"malwoden\";\r\nimport { RenderSystem } from \"./systems/RenderSystem\";\r\nimport { InputSystem } from \"./systems/InputSystem\";\r\nimport { MovementSystem } from \"./systems/MovementSystem\";\r\nimport { Log } from \"./logs\";\r\nimport { GameState } from \"./globals\";\r\nimport { AISystem } from \"./systems/AISystem\";\r\nimport { StairSystem } from \"./systems/StairSystem\";\r\nimport { CacheSystem } from \"./systems/CacheSystem\";\r\nimport { CombatSystem } from \"./systems/CombatSystem\";\r\nimport { map_height, map_width } from \"./stage\";\r\nimport { state } from \"./globals\";\r\nimport { ViewSystem } from \"./systems/ViewSystem\";\r\nimport { LevelSystem } from \"./systems/levelSystem\";\r\nimport { ConsumableSystem } from \"./systems/ConsumableSystem\";\r\n\r\n// Globals\r\nlet terminal: Terminal.RetroTerminal;\r\nlet mapTerminal: Terminal.PortTerminal;\r\n\r\n// Systems\r\nconst renderSystem = new RenderSystem();\r\nconst inputSystem = new InputSystem();\r\nconst movementSystem = new MovementSystem();\r\nconst aiSystem = new AISystem();\r\nconst stairSystem = new StairSystem();\r\nconst cacheSystem = new CacheSystem();\r\nconst viewSystem = new ViewSystem();\r\nconst combatSystem = new CombatSystem();\r\nconst levelSystem = new LevelSystem();\r\nconst consumableSystem = new ConsumableSystem();\r\n\r\nexport function init(term: Terminal.RetroTerminal) {\r\n  terminal = term;\r\n  mapTerminal = terminal.port({ x: 17, y: 1 }, map_width, map_height);\r\n\r\n  Log.addEntryHigh(\"Game Start!\");\r\n\r\n  // Render once to start\r\n  renderSystem.loop({\r\n    stage: state.stage,\r\n    mapTerminal,\r\n    terminal,\r\n  });\r\n}\r\n\r\nexport function loop() {\r\n  // Cache System should always run first to build up cache\r\n  cacheSystem.loop();\r\n\r\n  if (\r\n    state.currentGameState === GameState.GAME_WIN ||\r\n    state.currentGameState === GameState.GAME_LOSS\r\n  ) {\r\n    // Input, render, return\r\n    inputSystem.loop(state.stage);\r\n    renderSystem.loop({\r\n      stage: state.stage,\r\n      mapTerminal,\r\n      terminal,\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Input System\r\n  if (state.currentGameState === GameState.AWAITING_INPUT) {\r\n    const wasInput = inputSystem.loop(state.stage);\r\n    if (wasInput) state.currentGameState = GameState.PLAYER_TURN;\r\n  }\r\n\r\n  // Logic Systems\r\n  movementSystem.loop(state.stage);\r\n  consumableSystem.loop(state.stage);\r\n  stairSystem.loop(state.stage);\r\n  viewSystem.loop(state.stage);\r\n  combatSystem.loop(state.stage);\r\n  levelSystem.loop(state.stage);\r\n\r\n  if (state.currentGameState === GameState.ENEMY_TURN) {\r\n    aiSystem.loop(state.stage);\r\n  }\r\n\r\n  // Transition between needed states\r\n  // Keep logic above, this is just for automatic\r\n  // transitions between states\r\n  if (state.currentGameState === GameState.GAME_START) {\r\n    state.currentGameState = GameState.AWAITING_INPUT;\r\n  } else if (state.currentGameState === GameState.PLAYER_TURN) {\r\n    state.currentGameState = GameState.ENEMY_TURN;\r\n  } else if (state.currentGameState === GameState.ENEMY_TURN) {\r\n    state.currentGameState = GameState.AWAITING_INPUT;\r\n  }\r\n\r\n  // Render comes very last\r\n  renderSystem.loop({\r\n    stage: state.stage,\r\n    mapTerminal,\r\n    terminal,\r\n  });\r\n}\r\n","import { Entity } from \"./entities\";\r\n\r\nfunction notifyDamage(source: string, power: number, target: Entity) {\r\n  if (!target.incomingDamage) {\r\n    target.incomingDamage = [];\r\n  }\r\n  target.incomingDamage?.push({ source, damage: power });\r\n}\r\n\r\nfunction calcAttack(source: Entity): number {\r\n  let totalAttack = 0;\r\n  if (source.stats) {\r\n    totalAttack = source.stats.attack;\r\n  }\r\n\r\n  return totalAttack;\r\n}\r\n\r\nfunction calcDefence(target: Entity): number {\r\n  let totalDefence = 0;\r\n  if (target.stats) {\r\n    //verifies that target has stats and is a valid target.\r\n    totalDefence = totalDefence + target.stats?.armor;\r\n  }\r\n\r\n  return totalDefence;\r\n}\r\n\r\nexport function dealDamage(source: Entity, target: Entity) {\r\n  let defence; //setup for more complicated defence formula.\r\n  let attack; //setup for comre complicated attack formula.\r\n\r\n  defence = calcDefence(target);\r\n  attack = calcAttack(source);\r\n  let power: number = 0;\r\n  power = attack - defence;\r\n  if (power < 0) {\r\n    power = 1;\r\n  }\r\n  notifyDamage(source.name, power, target);\r\n}\r\n","import { Rand, Pathfinding, Vector2 } from \"malwoden\";\r\nimport { Entity } from \"../entities\";\r\nimport { Direction, state } from \"../globals\";\r\nimport { Stage } from \"../stage\";\r\nimport { TerrainCollision } from \"../terrain\";\r\n\r\nexport class AISystem {\r\n  rng = new Rand.AleaRNG();\r\n\r\n  getRandDirection(): Direction | undefined {\r\n    return this.rng.nextItem([\r\n      Direction.UP,\r\n      Direction.DOWN,\r\n      Direction.LEFT,\r\n      Direction.RIGHT,\r\n      undefined,\r\n    ]);\r\n  }\r\n\r\n  loop(stage: Stage) {\r\n    for (let e of stage.entites) {\r\n      if (e.ai === \"chase\") {\r\n        this.chaseAI(e);\r\n      } else if (e.ai === \"wander\") {\r\n        this.wanderAI(e);\r\n      } else if (e.ai === \"guard\") {\r\n        this.guardAI(e);\r\n      }\r\n    }\r\n  }\r\n\r\n  private guardAI(e: Entity) {\r\n    const player = state.playerCache!;\r\n    // Will be undefined unless directly next to player\r\n    const direction = this.getDirectionFromVectors(e.position, player.position);\r\n    // If directly next to the player, attack\r\n    if (direction) {\r\n      e.wantsToMove = direction;\r\n    }\r\n  }\r\n\r\n  private chaseAI(e: Entity) {\r\n    if (!e.viewShed) throw new Error(`${e.name} does not have a viewshed!`);\r\n    const playerPos = state.playerCache!.position;\r\n    if (e.viewShed.area.has(`${playerPos.x}:${playerPos.y}`)) {\r\n      const p = new Pathfinding.AStar({\r\n        topology: \"four\",\r\n        isBlockedCallback: (pos) => {\r\n          if (pos.x === playerPos.x && pos.y === playerPos.y) return false;\r\n\r\n          // Check terrain\r\n          const terrain = state.stage.map.get(pos);\r\n          if (terrain && TerrainCollision[terrain]) return true;\r\n\r\n          // Default not blocked\r\n          return false;\r\n        },\r\n      });\r\n      const route = p.compute(e.position, playerPos);\r\n      if (route && route.length >= 2) {\r\n        const direction = this.getDirectionFromVectors(route[0], route[1]);\r\n        if (!direction) {\r\n          console.warn(\"No direction found for\", route[0], route[1]);\r\n        } else {\r\n          e.wantsToMove = direction;\r\n        }\r\n      }\r\n    } else {\r\n      this.wanderAI(e);\r\n    }\r\n  }\r\n\r\n  private getDirectionFromVectors(\r\n    start: Vector2,\r\n    next: Vector2\r\n  ): Direction | undefined {\r\n    const dx = next.x - start.x;\r\n    const dy = next.y - start.y;\r\n\r\n    // Convert to direction\r\n    if (dx === 1 && dy === 0) {\r\n      return Direction.RIGHT;\r\n    } else if (dx === -1 && dy === 0) {\r\n      return Direction.LEFT;\r\n    } else if (dx === 0 && dy === 1) {\r\n      return Direction.DOWN;\r\n    } else if (dx === 0 && dy === -1) {\r\n      return Direction.UP;\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private wanderAI(e: Entity) {\r\n    const dir = this.getRandDirection();\r\n    if (dir) {\r\n      e.wantsToMove = dir;\r\n    }\r\n  }\r\n}\r\n","import { restart, state } from \"../globals\";\r\nimport { Stage } from \"../stage\";\r\nimport { Log } from \"../logs\";\r\nimport { selectStage } from \"../generation/generation\";\r\n\r\nexport class StairSystem {\r\n  loop(stage: Stage) {\r\n    const player = stage.entites.find((x) => x.player);\r\n    const stairs = stage.entites.filter((x) => x.stairs);\r\n\r\n    for (let s of stairs) {\r\n      if (\r\n        s.position.x === player?.position.x &&\r\n        s.position.y === player.position.y\r\n      ) {\r\n        if (s.restart) {\r\n          restart();\r\n        } else {\r\n          Log.addEntryMid(\"Descending the stairs\");\r\n          state.stageCount++;\r\n          const newLevel = selectStage(state.stageCount);\r\n          newLevel.addEntity(player);\r\n          state.stage = newLevel;\r\n          player.position.x = newLevel.startPos.x;\r\n          player.position.y = newLevel.startPos.y;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { state } from \"../globals\";\r\n\r\nexport class CacheSystem {\r\n  loop() {\r\n    // Update the position cache\r\n    state.posCache.clear();\r\n    for (let e of state.stage.entites) {\r\n      const key = `${e.position.x}:${e.position.y}`;\r\n\r\n      if (state.posCache.has(key)) {\r\n        state.posCache.get(key)?.push(e);\r\n      } else {\r\n        state.posCache.set(key, [e]);\r\n      }\r\n\r\n      // Update the player cache\r\n      if (e.player) {\r\n        state.playerCache = e;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Entity } from \"../entities\";\r\nimport { Stage } from \"../stage\";\r\nimport { Log } from \"../logs\";\r\nimport { GameState, state } from \"../globals\";\r\nimport { Glyph, Color } from \"malwoden\";\r\n\r\nexport class CombatSystem {\r\n  ///\r\n\r\n  private makeCorpse(futureCorpse: Entity) {\r\n    if (futureCorpse.name === \"Mal\") {\r\n      Log.addEntryWarning(\"You have died.\");\r\n      state.currentGameState = GameState.GAME_LOSS;\r\n    }\r\n    Log.addEntryMid(futureCorpse.name + \" has died horribly.\");\r\n    if (state.playerCache && state.playerCache.stats && futureCorpse.stats) {\r\n      state.playerCache.stats.exp =\r\n        state.playerCache.stats?.exp + futureCorpse.stats?.exp;\r\n    }\r\n    futureCorpse.renderPriority = 3;\r\n    futureCorpse.enemy = false;\r\n    futureCorpse.collision = false;\r\n    futureCorpse.stats = undefined;\r\n    futureCorpse.ai = undefined;\r\n    futureCorpse.name += \" (corpse)\";\r\n    futureCorpse.glyph = new Glyph(\"x\", Color.White);\r\n\r\n    return futureCorpse;\r\n  }\r\n\r\n  private checkAlive(check: Entity) {\r\n    if (check.stats) {\r\n      if (check.stats.hp > 0) {\r\n        return true;\r\n      }\r\n      this.makeCorpse(check);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private applyDamage(\r\n    creature: Entity,\r\n    incDamage: { source: string; damage: number }\r\n  ) {\r\n    if (creature && creature.stats) {\r\n      creature.stats.hp = creature.stats.hp - incDamage.damage;\r\n    }\r\n  }\r\n\r\n  loop(stage: Stage) {\r\n    for (let e of stage.entites) {\r\n      while (e.incomingDamage && e.incomingDamage.length > 0) {\r\n        //check to see if the current entity has damage being logged against them.\r\n        let incDamage = e.incomingDamage.pop()!;\r\n\r\n        this.applyDamage(e, incDamage);\r\n        Log.addEntryLow(\r\n          e.name +\r\n            \" was hit for \" +\r\n            incDamage.damage +\r\n            \" by \" +\r\n            incDamage.source\r\n        );\r\n\r\n        //confim if target is alive, if dead, makes a corpse;\r\n        this.checkAlive(e);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { FOV, Vector2 } from \"malwoden\";\r\nimport { Stage } from \"../stage\";\r\nimport { state } from \"../globals\";\r\nimport { TerrainBlocksVision } from \"../terrain\";\r\n\r\nexport class ViewSystem {\r\n  fov = new FOV.PreciseShadowcasting({\r\n    topology: \"eight\",\r\n    cartesianRange: true,\r\n    lightPasses: (pos) => {\r\n      const terrain = state.stage.map.get(pos);\r\n      if (!terrain) return true;\r\n      else return TerrainBlocksVision[terrain] === false;\r\n    },\r\n  });\r\n\r\n  loop(level: Stage) {\r\n    // Loop through entities\r\n    for (const e of level.entites) {\r\n      if (!e.vision) continue;\r\n      if (e.viewShed && e.viewShed.dirty === false) continue;\r\n\r\n      if (e.vision && (!e.viewShed || e.viewShed.dirty)) {\r\n        // Calculate\r\n        const tiles = this.fov.calculateArray(e.position, e.vision);\r\n        const area = new Map<string, Vector2>();\r\n        for (const t of tiles) {\r\n          area.set(`${t.pos.x}:${t.pos.y}`, t.pos);\r\n        }\r\n\r\n        // Set area and mark viewshed as clean\r\n        e.viewShed = {\r\n          area,\r\n          dirty: false,\r\n        };\r\n        // If we're updating the player, update the level's\r\n        // visited table\r\n        if (e.player) {\r\n          for (const t of tiles) {\r\n            if (level.fowVisited.isInBounds(t.pos)) {\r\n              level.fowVisited.set(t.pos, true);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Stage } from \"../stage\";\r\nimport { GameState, state } from \"../globals\";\r\nimport { Log } from \"../logs\";\r\n\r\nexport class ConsumableSystem {\r\n  loop(stage: Stage) {\r\n    const player = state.playerCache!;\r\n\r\n    const entitesOnSpace =\r\n      state.posCache.get(`${player.position.x}:${player.position.y}`) || [];\r\n\r\n    for (let e of entitesOnSpace) {\r\n      if (e.consumable) {\r\n        if (\r\n          e.position.x === player.position.x &&\r\n          e.position.y === player.position.y\r\n        ) {\r\n          let consumed = false;\r\n          // Player is over a consumable\r\n          if (e.consumable.hp && player.stats!.hp < player.stats!.maxHp) {\r\n            player.stats!.hp = Math.min(\r\n              player.stats!.maxHp,\r\n              player.stats!.hp + e.consumable.hp\r\n            );\r\n            Log.addEntryMid(\r\n              `You ate a ${e.name} and regained ${e.consumable.hp} hp!`\r\n            );\r\n            consumed = true;\r\n          }\r\n          if (e.consumable.exp) {\r\n            Log.addEntryMid(\r\n              `You read a ${e.name} and gained ${e.consumable.exp} exp!`\r\n            );\r\n            player.stats!.exp += e.consumable.exp;\r\n            consumed = true;\r\n          }\r\n\r\n          if (e.consumable.winCondition) {\r\n            state.currentGameState = GameState.GAME_WIN;\r\n            consumed = true;\r\n          }\r\n\r\n          // Delete if consumed\r\n          if (consumed) {\r\n            state.stage.removeEntity(e);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import React, { useEffect } from \"react\";\r\nimport { Terminal } from \"malwoden\";\r\n\r\nimport * as Game from \"./game\";\r\n\r\nfunction App() {\r\n  const requestRef = React.useRef<number>(NaN);\r\n\r\n  useEffect(() => {\r\n    const mount = document.getElementById(\"malwoden\")!;\r\n    const terminal = new Terminal.RetroTerminal({\r\n      width: 70,\r\n      height: 50,\r\n      imageURL: \"./font_16.png\",\r\n      charWidth: 16,\r\n      charHeight: 16,\r\n      mountNode: mount,\r\n    });\r\n\r\n    Game.init(terminal);\r\n\r\n    const loop = () => {\r\n      Game.loop();\r\n      requestRef.current = window.requestAnimationFrame(loop);\r\n    };\r\n    requestRef.current = window.requestAnimationFrame(loop);\r\n    return () => window.cancelAnimationFrame(requestRef.current);\r\n  }, []);\r\n  return (\r\n    <div\r\n      id=\"malwoden\"\r\n      style={{ display: \"flex\", justifyContent: \"center\", paddingTop: \"50px\" }}\r\n    ></div>\r\n  );\r\n}\r\n\r\nexport default App;\r\n","const reportWebVitals = onPerfEntry => {\r\n  if (onPerfEntry && onPerfEntry instanceof Function) {\r\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\r\n      getCLS(onPerfEntry);\r\n      getFID(onPerfEntry);\r\n      getFCP(onPerfEntry);\r\n      getLCP(onPerfEntry);\r\n      getTTFB(onPerfEntry);\r\n    });\r\n  }\r\n};\r\n\r\nexport default reportWebVitals;\r\n","import React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport App from \"./App\";\r\nimport reportWebVitals from \"./reportWebVitals\";\r\n\r\nReactDOM.render(\r\n  <React.StrictMode>\r\n    <App />\r\n  </React.StrictMode>,\r\n  document.getElementById(\"root\")\r\n);\r\n\r\n// If you want to start measuring performance in your app, pass a function\r\n// to log results (for example: reportWebVitals(console.log))\r\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\r\nreportWebVitals();\r\n"],"sourceRoot":""}